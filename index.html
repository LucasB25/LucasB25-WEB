<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Studio - Pro Edition</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0f1c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="QR Studio">
    <meta name="apple-mobile-web-app-title" content="QR Studio">
    
    <!-- Placeholder pour le Manifest dynamique -->
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" type="image/png" id="favicon-placeholder">
    <link rel="apple-touch-icon" id="apple-icon-placeholder">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librairie QRious -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        bg: {
                            main: '#0a0f1c',
                            card: 'rgba(23, 32, 51, 0.8)',
                            input: 'rgba(30, 41, 59, 0.5)',
                        },
                        brand: {
                            DEFAULT: '#4f46e5', // Indigo 600
                            hover: '#4338ca',   // Indigo 700
                            accent: '#818cf8',  // Indigo 400
                        },
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(79, 70, 229, 0.15)',
                        'card': '0 25px 50px -12px rgba(0, 0, 0, 0.5)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0a0f1c;
            background-image: 
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%);
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            /* Empêche le rebond sur iOS pour une sensation native */
            overscroll-behavior-y: none;
        }

        /* --- Glassmorphism Pro --- */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- Inputs Custom --- */
        .input-group {
            background: var(--bg-input);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-group:focus-within {
            border-color: #818cf8;
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.3);
        }
        .input-group input::placeholder {
            color: #64748b;
        }
        .input-group input, .input-group select, .input-group textarea {
            background: transparent;
            border: none;
            outline: none;
            color: white;
            width: 100%;
        }

        /* --- Tab System --- */
        .tab-btn {
            position: relative;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #818cf8;
            box-shadow: 0 0 10px #818cf8;
        }

        /* --- Toggle Switch --- */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-track { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-track .toggle-thumb { transform: translateX(100%); }

        /* --- Color Picker Invisible --- */
        .color-wrapper { position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .color-wrapper:hover { transform: scale(1.02); border-color: rgba(255,255,255,0.3); }
        .color-input-hidden { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* --- Custom Select --- */
        .select-wrapper { position: relative; z-index: 10; }
        .select-wrapper.active { z-index: 100 !important; }
        .select-options { opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .select-wrapper.active .select-options { opacity: 1; visibility: visible; transform: translateY(0); }
        
        /* --- Download Menu --- */
        #download-menu { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom center; }
        #download-menu.hidden-menu { opacity: 0; visibility: hidden; transform: translateY(10px) scale(0.95); }
        #download-menu.visible-menu { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }

        /* --- Install Button Animation --- */
        #install-btn { display: none; } /* Hidden by default */
        #install-btn.visible { display: flex; animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        /* --- Pattern de Transparence --- */
        .transparent-grid {
            background-color: #f8fafc;
            background-image: linear-gradient(45deg, #cbd5e1 25%, transparent 25%), linear-gradient(-45deg, #cbd5e1 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #cbd5e1 75%), linear-gradient(-45deg, transparent 75%, #cbd5e1 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
        }
        .disabled-look { opacity: 0.5; pointer-events: none; filter: grayscale(0.8); }
        
        /* Form Sections */
        .form-section { display: none; animation: fadeIn 0.3s ease-out; }
        .form-section.active { display: block; }
    </style>
</head>
<body class="flex items-center justify-center p-4 md:p-8 min-h-screen">

    <div class="glass-panel w-full max-w-6xl rounded-3xl overflow-hidden flex flex-col lg:flex-row shadow-card animate-fade-in relative z-10">
        
        <!-- ================= GAUCHE : CONFIGURATION ================= -->
        <div class="w-full lg:w-5/12 p-0 border-b lg:border-b-0 lg:border-r border-white/5 bg-[#0f172a]/40 flex flex-col overflow-hidden h-[85vh] lg:h-[800px]">
            
            <!-- Header -->
            <div class="p-8 pb-4 shrink-0 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-brand to-brand-hover flex items-center justify-center text-white shadow-neon ring-1 ring-white/10">
                        <i class="fa-solid fa-qrcode text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-white">QR Studio</h1>
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                            <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Multi-Format</p>
                        </div>
                    </div>
                </div>
                
                <!-- INSTALL PWA BUTTON -->
                <button id="install-btn" class="bg-brand text-white px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 hover:bg-brand-hover transition-colors shadow-lg">
                    <i class="fa-solid fa-download"></i> Installer
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scroll p-8 pt-0 space-y-6">

                <!-- 1. TABS SELECTOR -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1 mb-3 block">Type de Contenu</label>
                    <div class="grid grid-cols-4 gap-2 bg-[#0a0f1c]/50 p-1 rounded-xl mb-4">
                        <button onclick="switchTab('url')" class="tab-btn active flex flex-col items-center justify-center py-2 rounded-lg text-slate-400 hover:text-white" id="tab-url">
                            <i class="fa-solid fa-link mb-1"></i>
                            <span class="text-[10px] font-bold">Lien</span>
                        </button>
                        <button onclick="switchTab('wifi')" class="tab-btn flex flex-col items-center justify-center py-2 rounded-lg text-slate-400 hover:text-white" id="tab-wifi">
                            <i class="fa-solid fa-wifi mb-1"></i>
                            <span class="text-[10px] font-bold">WiFi</span>
                        </button>
                        <button onclick="switchTab('vcard')" class="tab-btn flex flex-col items-center justify-center py-2 rounded-lg text-slate-400 hover:text-white" id="tab-vcard">
                            <i class="fa-regular fa-id-card mb-1"></i>
                            <span class="text-[10px] font-bold">VCard</span>
                        </button>
                        <button onclick="switchTab('email')" class="tab-btn flex flex-col items-center justify-center py-2 rounded-lg text-slate-400 hover:text-white" id="tab-email">
                            <i class="fa-regular fa-envelope mb-1"></i>
                            <span class="text-[10px] font-bold">Email</span>
                        </button>
                    </div>

                    <!-- --- FORM: URL/TEXT --- -->
                    <div id="form-url" class="form-section active">
                        <div class="input-group rounded-xl flex items-center px-4 py-3.5">
                            <i class="fa-solid fa-link text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-url" class="font-medium" placeholder="https://votre-site.com" value="https://google.com">
                        </div>
                    </div>

                    <!-- --- FORM: WIFI --- -->
                    <div id="form-wifi" class="form-section space-y-3">
                        <div class="input-group rounded-xl flex items-center px-4 py-3">
                            <i class="fa-solid fa-network-wired text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-wifi-ssid" placeholder="Nom du réseau (SSID)">
                        </div>
                        <div class="input-group rounded-xl flex items-center px-4 py-3">
                            <i class="fa-solid fa-key text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-wifi-pass" placeholder="Mot de passe">
                        </div>
                        <div class="input-group rounded-xl flex items-center px-4 py-3">
                            <i class="fa-solid fa-lock text-slate-500 mr-3 text-sm"></i>
                            <select id="inp-wifi-type" class="bg-transparent text-slate-300">
                                <option value="WPA" class="bg-[#1e293b]">WPA/WPA2 (Standard)</option>
                                <option value="WEP" class="bg-[#1e293b]">WEP</option>
                                <option value="nopass" class="bg-[#1e293b]">Aucun mot de passe</option>
                            </select>
                        </div>
                    </div>

                    <!-- --- FORM: VCARD --- -->
                    <div id="form-vcard" class="form-section space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="input-group rounded-xl px-4 py-3"><input type="text" id="inp-vc-name" placeholder="Nom"></div>
                            <div class="input-group rounded-xl px-4 py-3"><input type="text" id="inp-vc-surname" placeholder="Prénom"></div>
                        </div>
                        <div class="input-group rounded-xl px-4 py-3 flex items-center">
                            <i class="fa-solid fa-phone text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-vc-phone" placeholder="Téléphone">
                        </div>
                        <div class="input-group rounded-xl px-4 py-3 flex items-center">
                            <i class="fa-solid fa-envelope text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-vc-email" placeholder="Email">
                        </div>
                        <div class="input-group rounded-xl px-4 py-3 flex items-center">
                            <i class="fa-solid fa-building text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-vc-org" placeholder="Entreprise / Organisation">
                        </div>
                        <div class="input-group rounded-xl px-4 py-3 flex items-center">
                            <i class="fa-solid fa-globe text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-vc-web" placeholder="Site Web">
                        </div>
                    </div>

                    <!-- --- FORM: EMAIL --- -->
                    <div id="form-email" class="form-section space-y-3">
                        <div class="input-group rounded-xl flex items-center px-4 py-3">
                            <i class="fa-solid fa-at text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-mail-dest" placeholder="Destinataire">
                        </div>
                        <div class="input-group rounded-xl flex items-center px-4 py-3">
                            <i class="fa-solid fa-heading text-slate-500 mr-3 text-sm"></i>
                            <input type="text" id="inp-mail-obj" placeholder="Objet du mail">
                        </div>
                        <div class="input-group rounded-xl px-4 py-3">
                            <textarea id="inp-mail-body" rows="3" placeholder="Message..." class="bg-transparent w-full text-white outline-none resize-none"></textarea>
                        </div>
                    </div>

                </div>

                <!-- 2. COULEURS -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Couleur</label>
                        <div class="color-wrapper input-group h-12 rounded-xl flex items-center px-3 gap-3 hover:bg-white/5">
                            <div id="preview-fg-dot" class="w-6 h-6 rounded-full bg-black shadow-lg border border-white/20 shrink-0"></div>
                            <div class="flex flex-col">
                                <span id="label-fg" class="text-xs font-mono text-white font-semibold">#000000</span>
                            </div>
                            <input type="color" id="qr-foreground" value="#000000" class="color-input-hidden">
                        </div>
                    </div>

                    <div class="space-y-2" id="bg-section">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Fond</label>
                        <div class="color-wrapper input-group h-12 rounded-xl flex items-center px-3 gap-3 hover:bg-white/5">
                            <div id="preview-bg-dot" class="w-6 h-6 rounded-full bg-white shadow-lg shrink-0"></div>
                            <div class="flex flex-col">
                                <span id="label-bg" class="text-xs font-mono text-white font-semibold">#FFFFFF</span>
                            </div>
                            <input type="color" id="qr-background" value="#ffffff" class="color-input-hidden">
                        </div>
                    </div>
                </div>

                <!-- 3. OPTIONS -->
                <div class="space-y-4 pt-2">
                    <div class="input-group rounded-xl p-3 flex items-center justify-between cursor-pointer group" onclick="document.getElementById('transparent-toggle').click()">
                        <div class="flex items-center gap-3">
                            <div class="bg-brand/10 p-2 rounded-lg text-brand-accent">
                                <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-semibold text-white group-hover:text-brand-accent transition-colors">Fond Transparent</span>
                            </div>
                        </div>
                        <div class="relative w-11 h-6 select-none pointer-events-none">
                            <input type="checkbox" id="transparent-toggle" class="toggle-checkbox sr-only">
                            <div class="toggle-track w-full h-full bg-slate-700/50 rounded-full transition-colors duration-300">
                                <div class="toggle-thumb absolute top-[2px] left-[2px] bg-white rounded-full h-5 w-5 shadow-sm transition-transform duration-300"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ECC Select -->
                    <div class="select-wrapper" id="ecc-select">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 block pl-1">Correction d'erreur</label>
                        <div class="input-group w-full rounded-xl px-4 py-3 flex justify-between items-center cursor-pointer hover:border-brand-accent/30 transition" onclick="toggleEcc(event)">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved text-slate-500 text-xs"></i>
                                <span id="selected-ecc-label" class="text-sm font-semibold text-white">Niveau H (30%)</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-xs text-slate-500 transition-transform duration-300" id="ecc-arrow"></i>
                        </div>
                        <div class="select-options absolute bottom-full mb-2 left-0 w-full bg-[#1e293b] border border-white/10 rounded-xl shadow-2xl overflow-hidden p-1.5">
                            <div class="p-2.5 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group" onclick="setEcc('L', 'Niveau L (7%)')"><span class="text-sm text-slate-300 group-hover:text-white">Niveau L</span></div>
                            <div class="p-2.5 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group" onclick="setEcc('M', 'Niveau M (15%)')"><span class="text-sm text-slate-300 group-hover:text-white">Niveau M</span></div>
                            <div class="p-2.5 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group" onclick="setEcc('Q', 'Niveau Q (25%)')"><span class="text-sm text-slate-300 group-hover:text-white">Niveau Q</span></div>
                            <div class="p-2.5 rounded-lg bg-brand/10 cursor-pointer flex justify-between items-center mb-1" onclick="setEcc('H', 'Niveau H (30%)')"><span class="text-sm font-bold text-brand-accent">Niveau H</span></div>
                        </div>
                        <input type="hidden" id="qr-ecc" value="H">
                    </div>

                    <!-- Quality Select -->
                    <div class="select-wrapper" id="quality-select">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 block pl-1">Qualité</label>
                        <div class="input-group w-full rounded-xl px-4 py-3 flex justify-between items-center cursor-pointer hover:border-brand-accent/30 transition" onclick="toggleSelect(event)">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-expand text-slate-500 text-xs"></i>
                                <span id="selected-quality-label" class="text-sm font-semibold text-white">Haute Définition (800px)</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-xs text-slate-500 transition-transform duration-300" id="select-arrow"></i>
                        </div>
                        <div class="select-options absolute bottom-full mb-2 left-0 w-full bg-[#1e293b] border border-white/10 rounded-xl shadow-2xl overflow-hidden p-1.5">
                            <div class="p-2.5 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group" onclick="setQuality(400, 'Standard (400px)')"><span class="text-sm text-slate-300 group-hover:text-white">Standard</span></div>
                            <div class="p-2.5 rounded-lg bg-brand/10 cursor-pointer flex justify-between items-center mb-1" onclick="setQuality(800, 'Haute Définition (800px)')"><span class="text-sm font-bold text-brand-accent">Haute Définition</span></div>
                            <div class="p-2.5 rounded-lg hover:bg-white/5 cursor-pointer flex justify-between items-center group" onclick="setQuality(2000, 'Impression Pro (2000px)')"><span class="text-sm text-slate-300 group-hover:text-white">Impression Pro</span></div>
                        </div>
                        <input type="hidden" id="qr-size" value="800">
                    </div>
                </div>

                <div class="h-8"></div> <!-- Spacer -->
            </div>
        </div>

        <!-- ================= DROITE : APERÇU ================= -->
        <div class="w-full lg:w-7/12 bg-[#0b101b]/50 relative flex flex-col justify-between min-h-[500px] overflow-hidden">
            
            <div class="flex-1 flex flex-col items-center justify-center p-8 lg:p-12 relative w-full">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-brand/20 rounded-full blur-[80px] pointer-events-none"></div>
                
                <div class="relative z-10 group">
                    <div class="transparent-grid p-4 rounded-2xl shadow-card border border-white/10 bg-white">
                        <canvas id="qr-code" class="block rounded-lg w-full h-auto max-w-[280px] lg:max-w-[320px]"></canvas>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-center opacity-0 group-hover:opacity-100 transition-all duration-300">
                    <span class="px-4 py-1.5 rounded-full bg-[#0f172a]/90 backdrop-blur border border-white/10 text-[10px] font-bold uppercase tracking-widest text-emerald-400 shadow-lg">
                        Prêt à l'export
                    </span>
                </div>
            </div>

            <div class="p-6 lg:p-8 border-t border-white/5 bg-[#0f172a]/60 backdrop-blur-md relative z-50">
                <div class="grid grid-cols-3 gap-4 max-w-lg mx-auto">
                    
                    <!-- Download (Menu) -->
                    <div class="relative group">
                        <div id="download-menu" class="hidden-menu absolute bottom-full left-0 w-full mb-3 bg-[#1e293b] border border-white/10 rounded-xl shadow-2xl overflow-hidden p-1.5 flex flex-col gap-1 z-50">
                            <button onclick="downloadFormat('png_trans')" class="w-full text-left p-2.5 rounded-lg hover:bg-white/5 flex items-center justify-between group/item">
                                <div class="flex items-center gap-2"><i class="fa-solid fa-file-image text-brand-accent text-xs"></i><span class="text-sm text-slate-300 group-hover/item:text-white">PNG</span></div><span class="text-[9px] bg-brand/20 text-brand-accent px-1.5 rounded">Transp.</span>
                            </button>
                            <button onclick="downloadFormat('png_white')" class="w-full text-left p-2.5 rounded-lg hover:bg-white/5 flex items-center justify-between group/item">
                                <div class="flex items-center gap-2"><i class="fa-regular fa-file-image text-slate-500 text-xs"></i><span class="text-sm text-slate-300 group-hover/item:text-white">PNG</span></div><span class="text-[9px] bg-white/10 text-slate-400 px-1.5 rounded">Blanc</span>
                            </button>
                            <button onclick="downloadFormat('jpeg')" class="w-full text-left p-2.5 rounded-lg hover:bg-white/5 flex items-center justify-between group/item">
                                <div class="flex items-center gap-2"><i class="fa-solid fa-image text-slate-500 text-xs"></i><span class="text-sm text-slate-300 group-hover/item:text-white">JPEG</span></div>
                            </button>
                            <button onclick="downloadSVG()" class="w-full text-left p-2.5 rounded-lg hover:bg-white/5 flex items-center justify-between group/item border-t border-white/5 mt-1 pt-2">
                                <div class="flex items-center gap-2"><i class="fa-solid fa-bezier-curve text-emerald-400 text-xs"></i><span class="text-sm text-slate-300 group-hover/item:text-white font-medium">SVG</span></div><span class="text-[9px] bg-emerald-500/20 text-emerald-400 px-1.5 rounded">Vector</span>
                            </button>
                        </div>

                        <button onclick="toggleDownloadMenu()" class="w-full relative overflow-hidden rounded-xl bg-white/5 hover:bg-brand border border-white/5 p-4 flex flex-col items-center justify-center gap-2 transition-all duration-300 active:scale-95">
                            <i class="fa-solid fa-download text-xl text-slate-400 group-hover:text-white transition-colors"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-500 group-hover:text-white transition-colors">Télécharger</span>
                            <div class="absolute top-2 right-2 opacity-50"><i class="fa-solid fa-chevron-up text-[8px] text-white"></i></div>
                        </button>
                    </div>
                    
                    <button onclick="printQR()" class="group relative overflow-hidden rounded-xl bg-white/5 hover:bg-brand-accent border border-white/5 p-4 flex flex-col items-center justify-center gap-2 transition-all duration-300 active:scale-95">
                        <i class="fa-solid fa-print text-xl text-slate-400 group-hover:text-white relative z-10 transition-colors"></i>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-500 group-hover:text-white relative z-10 transition-colors">Imprimer</span>
                    </button>
                    
                    <button onclick="shareQR()" class="group relative overflow-hidden rounded-xl bg-white/5 hover:bg-emerald-500 border border-white/5 p-4 flex flex-col items-center justify-center gap-2 transition-all duration-300 active:scale-95">
                        <i class="fa-solid fa-share-nodes text-xl text-slate-400 group-hover:text-white relative z-10 transition-colors"></i>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-500 group-hover:text-white relative z-10 transition-colors">Partager</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-white text-slate-900 px-6 py-3.5 rounded-full shadow-2xl transform -translate-y-32 transition-all duration-500 z-[100] flex items-center gap-3 font-semibold pointer-events-none opacity-0 border border-slate-100">
        <div class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600"><i class="fa-solid fa-check text-xs"></i></div>
        <span id="toast-msg" class="text-sm">Action effectuée</span>
    </div>

    <script>
        // --- PWA INIT ---
        // Génération automatique d'une icône SVG Base64 pour le Manifest et les Favicons
        const iconSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%234f46e5'/%3E%3Cpath fill='%23fff' d='M144 144h80v80h-80zm0 144h80v80h-80zm144 0h80v80h-80zm144-144h-80v80h80zM112 112v144h144V112H112zm0 144v144h144V256H112zm144 0h144v144H256V256zm32-112h80v80h-80v-80z'/%3E%3C/svg%3E`;
        
        // Configuration du Manifest
        const manifest = {
            "name": "QR Studio Pro",
            "short_name": "QR Studio",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0a0f1c",
            "theme_color": "#4f46e5",
            "icons": [{ "src": iconSvg, "sizes": "512x512", "type": "image/svg+xml" }]
        };

        // Injection du Manifest et des Icônes
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(manifestBlob);
        document.getElementById('favicon-placeholder').href = iconSvg;
        document.getElementById('apple-icon-placeholder').href = iconSvg;

        // Gestionnaire d'installation PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.add('visible');
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.remove('visible');
                }
            }
        });

        // --- APP LOGIC ---
        const ui = {
            canvas: document.getElementById('qr-code'),
            fg: document.getElementById('qr-foreground'),
            bg: document.getElementById('qr-background'),
            bgSection: document.getElementById('bg-section'),
            transparentToggle: document.getElementById('transparent-toggle'),
            size: document.getElementById('qr-size'),
            ecc: document.getElementById('qr-ecc'),
            downloadMenu: document.getElementById('download-menu'),
            previewFg: document.getElementById('preview-fg-dot'),
            previewBg: document.getElementById('preview-bg-dot'),
            labelFg: document.getElementById('label-fg'),
            labelBg: document.getElementById('label-bg'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            qualityWrapper: document.getElementById('quality-select'),
            qualityLabel: document.getElementById('selected-quality-label'),
            qualityArrow: document.getElementById('select-arrow'),
            eccWrapper: document.getElementById('ecc-select'),
            eccLabel: document.getElementById('selected-ecc-label'),
            eccArrow: document.getElementById('ecc-arrow'),
            
            // Inputs Spécifiques
            inpUrl: document.getElementById('inp-url'),
            
            inpWifiSsid: document.getElementById('inp-wifi-ssid'),
            inpWifiPass: document.getElementById('inp-wifi-pass'),
            inpWifiType: document.getElementById('inp-wifi-type'),
            
            inpVcName: document.getElementById('inp-vc-name'),
            inpVcSurname: document.getElementById('inp-vc-surname'),
            inpVcPhone: document.getElementById('inp-vc-phone'),
            inpVcEmail: document.getElementById('inp-vc-email'),
            inpVcOrg: document.getElementById('inp-vc-org'),
            inpVcWeb: document.getElementById('inp-vc-web'),

            inpMailDest: document.getElementById('inp-mail-dest'),
            inpMailObj: document.getElementById('inp-mail-obj'),
            inpMailBody: document.getElementById('inp-mail-body'),
        };

        let qr;
        let currentTab = 'url'; // 'url', 'wifi', 'vcard', 'email'

        function init() {
            try {
                qr = new QRious({
                    element: ui.canvas,
                    size: 800,
                    value: "https://google.com",
                    foreground: "#000000",
                    background: "#ffffff",
                    level: 'H',
                    padding: 25
                });
                updateQR();
            } catch (e) { console.error("Erreur init:", e); }
        }

        // --- GESTION DES ONGLETS ---
        window.switchTab = function(type) {
            currentTab = type;
            
            // UI Tabs Update
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');

            // UI Forms Update
            document.querySelectorAll('.form-section').forEach(form => form.classList.remove('active'));
            document.getElementById(`form-${type}`).classList.add('active');

            updateQR();
        }

        // --- GÉNÉRATION DU PAYLOAD QR ---
        function generatePayload() {
            if (currentTab === 'url') {
                return ui.inpUrl.value || "https://google.com";
            }
            
            if (currentTab === 'wifi') {
                const ssid = ui.inpWifiSsid.value;
                const pass = ui.inpWifiPass.value;
                const type = ui.inpWifiType.value;
                if (!ssid) return "WIFI:;";
                return `WIFI:T:${type};S:${ssid};P:${pass};;`;
            }

            if (currentTab === 'vcard') {
                const n = ui.inpVcName.value;
                const sn = ui.inpVcSurname.value;
                const tel = ui.inpVcPhone.value;
                const mail = ui.inpVcEmail.value;
                const org = ui.inpVcOrg.value;
                const web = ui.inpVcWeb.value;

                let vcard = `BEGIN:VCARD\nVERSION:3.0\nN:${sn};${n}\nFN:${n} ${sn}\n`;
                if(org) vcard += `ORG:${org}\n`;
                if(tel) vcard += `TEL;TYPE=CELL:${tel}\n`;
                if(mail) vcard += `EMAIL:${mail}\n`;
                if(web) vcard += `URL:${web}\n`;
                vcard += `END:VCARD`;
                return vcard;
            }

            if (currentTab === 'email') {
                const dest = ui.inpMailDest.value;
                const subj = encodeURIComponent(ui.inpMailObj.value);
                const body = encodeURIComponent(ui.inpMailBody.value);
                return `mailto:${dest}?subject=${subj}&body=${body}`;
            }

            return "Error";
        }

        function updateQR() {
            if (!qr) return;

            const isTransparent = ui.transparentToggle.checked;
            
            if(isTransparent) ui.bgSection.classList.add('disabled-look');
            else ui.bgSection.classList.remove('disabled-look');

            const payload = generatePayload();

            const config = {
                value: payload,
                foreground: ui.fg.value,
                background: ui.bg.value,
                backgroundAlpha: isTransparent ? 0 : 1.0,
                size: parseInt(ui.size.value),
                level: ui.ecc.value
            };

            qr.set(config);

            ui.previewFg.style.backgroundColor = config.foreground;
            ui.labelFg.innerText = config.foreground.toUpperCase();
            ui.previewBg.style.backgroundColor = config.background;
            ui.labelBg.innerText = config.background.toUpperCase();
        }

        // --- EVENTS ---
        
        // Listeners génériques sur tous les inputs spécifiques
        const allInputs = [
            ui.inpUrl, 
            ui.inpWifiSsid, ui.inpWifiPass, ui.inpWifiType,
            ui.inpVcName, ui.inpVcSurname, ui.inpVcPhone, ui.inpVcEmail, ui.inpVcOrg, ui.inpVcWeb,
            ui.inpMailDest, ui.inpMailObj, ui.inpMailBody
        ];
        allInputs.forEach(el => {
            el.addEventListener('input', updateQR);
            if(el.tagName === 'SELECT') el.addEventListener('change', updateQR);
        });

        ui.transparentToggle.addEventListener('change', updateQR);
        ['fg', 'bg'].forEach(key => {
            ui[key].addEventListener('input', updateQR);
            ui[key].addEventListener('change', updateQR);
        });

        // --- UI HELPERS ---
        function closeAllSelects(except) {
            if(except !== 'quality') { ui.qualityWrapper.classList.remove('active'); ui.qualityArrow.style.transform = 'rotate(0deg)'; }
            if(except !== 'ecc') { ui.eccWrapper.classList.remove('active'); ui.eccArrow.style.transform = 'rotate(0deg)'; }
            if(except !== 'download') { ui.downloadMenu.classList.remove('visible-menu'); ui.downloadMenu.classList.add('hidden-menu'); }
        }

        window.toggleSelect = function(e) { e.stopPropagation(); closeAllSelects('quality'); const isActive = ui.qualityWrapper.classList.contains('active'); if(isActive) { ui.qualityWrapper.classList.remove('active'); ui.qualityArrow.style.transform = 'rotate(0deg)'; } else { ui.qualityWrapper.classList.add('active'); ui.qualityArrow.style.transform = 'rotate(180deg)'; } };
        window.setQuality = function(val, label) { ui.size.value = val; ui.qualityLabel.innerText = label; closeAllSelects(); updateQR(); };

        window.toggleEcc = function(e) { e.stopPropagation(); closeAllSelects('ecc'); const isActive = ui.eccWrapper.classList.contains('active'); if(isActive) { ui.eccWrapper.classList.remove('active'); ui.eccArrow.style.transform = 'rotate(0deg)'; } else { ui.eccWrapper.classList.add('active'); ui.eccArrow.style.transform = 'rotate(180deg)'; } };
        window.setEcc = function(val, label) { ui.ecc.value = val; ui.eccLabel.innerText = label; closeAllSelects(); updateQR(); };
        
        window.toggleDownloadMenu = function() { const isVisible = ui.downloadMenu.classList.contains('visible-menu'); closeAllSelects('download'); if(isVisible) { ui.downloadMenu.classList.remove('visible-menu'); ui.downloadMenu.classList.add('hidden-menu'); } else { ui.downloadMenu.classList.remove('hidden-menu'); ui.downloadMenu.classList.add('visible-menu'); } };

        document.addEventListener('click', function(e) { if (!e.target.closest('.select-wrapper') && !e.target.closest('#download-menu') && !e.target.closest('button[onclick="toggleDownloadMenu()"]')) { closeAllSelects(); } });

        function showToast(msg) { ui.toastMsg.innerText = msg; ui.toast.classList.remove('-translate-y-32', 'opacity-0'); ui.toast.classList.add('translate-y-0', 'opacity-100'); setTimeout(() => { ui.toast.classList.add('-translate-y-32', 'opacity-0'); ui.toast.classList.remove('translate-y-0', 'opacity-100'); }, 3000); }

        // --- DOWNLOAD & PRINT (Idem précédent) ---
        window.downloadFormat = function(type) {
            const link = document.createElement('a');
            const data = generatePayload(); // Nom fichier basé sur contenu ?
            const fileName = currentTab + "-" + Date.now();
            
            if (type === 'png_trans') {
                link.download = `${fileName}.png`; link.href = ui.canvas.toDataURL("image/png");
            } else if (type === 'png_white') {
                const tempCanvas = document.createElement('canvas'); tempCanvas.width = ui.canvas.width; tempCanvas.height = ui.canvas.height; const ctx = tempCanvas.getContext('2d'); ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); ctx.drawImage(ui.canvas, 0, 0);
                link.download = `${fileName}-w.png`; link.href = tempCanvas.toDataURL("image/png");
            } else if (type === 'jpeg') {
                const tempCanvas = document.createElement('canvas'); tempCanvas.width = ui.canvas.width; tempCanvas.height = ui.canvas.height; const ctx = tempCanvas.getContext('2d'); ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); ctx.drawImage(ui.canvas, 0, 0);
                link.download = `${fileName}.jpg`; link.href = tempCanvas.toDataURL("image/jpeg", 0.92);
            }
            link.click(); closeAllSelects(); showToast('Téléchargement lancé !');
        };

        window.downloadSVG = function() {
            const size = 1000; const bg = ui.transparentToggle.checked ? 'transparent' : ui.bg.value;
            let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            if(bg !== 'transparent') svgContent += `<rect width="100%" height="100%" fill="${bg}"/>`;
            svgContent += `<image href="${ui.canvas.toDataURL('image/png')}" x="0" y="0" width="${size}" height="${size}" /></svg>`;
            const blob = new Blob([svgContent], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.download = `QR-Vector-${Date.now()}.svg`; link.href = url; link.click();
            closeAllSelects(); showToast('SVG généré !');
        };

        window.printQR = function() {
            const dataUrl = ui.canvas.toDataURL("image/png"); const win = window.open('', '_blank'); if(!win) return alert("Pop-ups bloqués");
            const doc = win.document; doc.title = "Impression QR Code";
            const style = doc.createElement('style'); style.textContent = `body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; background-color: #f9fafb; } .container { text-align: center; padding: 40px; border: 1px solid #e2e8f0; border-radius: 16px; background: white; } img { max-width: 400px; width: 100%; height: auto; } p { margin-top: 20px; color: #64748b; font-size: 14px; word-break: break-all; }`;
            doc.head.appendChild(style);
            const container = doc.createElement('div'); container.className = 'container';
            const img = doc.createElement('img'); img.src = dataUrl;
            
            // Affichage intelligent du texte en dessous selon le type
            const text = doc.createElement('p');
            if(currentTab === 'wifi') text.textContent = `WiFi: ${ui.inpWifiSsid.value}`;
            else if(currentTab === 'vcard') text.textContent = `Contact: ${ui.inpVcSurname.value} ${ui.inpVcName.value}`;
            else if(currentTab === 'email') text.textContent = `Email: ${ui.inpMailDest.value}`;
            else text.textContent = ui.inpUrl.value;

            container.appendChild(img); container.appendChild(text); doc.body.appendChild(container);
            img.onload = function() { setTimeout(() => { win.print(); }, 500); };
        };

        window.shareQR = async function() {
            if (navigator.share) {
                try {
                    const dataUrl = ui.canvas.toDataURL("image/png"); const blob = await (await fetch(dataUrl)).blob(); const file = new File([blob], "qrcode.png", { type: blob.type });
                    await navigator.share({ title: 'QR Code', text: 'Scan me', files: [file] }); showToast('Partagé avec succès !');
                } catch (e) { console.log(e); }
            } else { showToast('Partage non supporté'); }
        };

        window.onload = init;

    </script>
</body>
</html>